{% extends "base.html" %}
{% load static %}

{% block navbar_content %}
<a class="navbar-brand main-nav-brand" href="{% url 'landing_page' %}">
    <div class="logo-placeholder"></div>
    <span class="brand-text">Imagi</span>
</a>
{% endblock %}

{% block title %}Purchase Credits - Imagi{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'apps_styles.css' %}">
<link rel="stylesheet" href="{% static 'payments/payments_styles.css' %}">
{% endblock %}

{% block extra_js %}
<script src="https://js.stripe.com/v3/"></script>
{% endblock %}

{% block content %}
<div class="checkout-wrapper">
    <div class="checkout-inner">
        <h2>Purchase Credits</h2>
        
        <div class="checkout-section">
            <div class="credit-selection">
                <label for="credit_amount">Enter Amount ($5.00 - $100.00):</label>
                <div class="credit-input-wrapper">
                    <span class="currency-symbol">$</span>
                    <input 
                        type="number" 
                        name="credit_amount" 
                        id="credit_amount" 
                        class="credit-input" 
                        min="5" 
                        max="100" 
                        step="0.01"
                        value="5.00"
                        required
                    >
                </div>
                <div id="amount-error" class="error-message hidden"></div>
                <div class="credits-preview">
                    You will receive: <span id="credits-amount">5</span> credits
                </div>
            </div>
        </div>

        <div class="checkout-section">
            <form id="payment-form">
                {% csrf_token %}
                <div class="payment-element-container">
                    <div id="payment-element">
                        <!-- Stripe.js will insert the Payment Element here -->
                    </div>
                </div>
                <button id="submit" class="payment-button">
                    <div class="spinner hidden" id="spinner"></div>
                    <span id="button-text"><i class="fas fa-lock"></i> Pay now</span>
                </button>
                <div id="payment-message" class="hidden"></div>
            </form>

            <div class="secure-badge">
                <i class="fas fa-shield-alt"></i>
                <span>Secure Payment by Stripe</span>
            </div>
        </div>

        <div class="auth-links">
            <p><a href="{% url 'landing_page' %}">Cancel and Return Home</a></p>
        </div>
    </div>
</div>

<script>
    // Wait for DOM and Stripe.js to load
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Stripe
        const stripe = Stripe("{{ stripe_publishable_key }}");
        let elements;

        // Get CSRF token from the cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        initialize();

        document
            .querySelector("#payment-form")
            .addEventListener("submit", handleSubmit);

        // Initialize Stripe and elements
        async function initialize() {
            try {
                const amount = parseFloat(document.getElementById('credit_amount').value);
                const validation = validateAmount(amount);
                
                if (!validation.valid) {
                    throw new Error(validation.message);
                }

                const csrftoken = getCookie('csrftoken');
                if (!csrftoken) {
                    throw new Error('CSRF token not found');
                }

                const response = await fetch("{% url 'payments:create-payment-intent' %}", {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrftoken
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ 
                        credit_amount: amount
                    }),
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Network response was not ok');
                }

                const { clientSecret } = await response.json();

                const appearance = {
                    theme: 'stripe',
                    variables: {
                        colorPrimary: '#00a2ff',
                        colorBackground: '#ffffff',
                        colorText: '#30313d',
                        colorDanger: '#df1b41',
                        fontFamily: 'system-ui, sans-serif',
                        spacingUnit: '6px',
                        borderRadius: '4px',
                    }
                };
                
                elements = stripe.elements({ 
                    appearance, 
                    clientSecret,
                    loader: 'auto',
                });

                const paymentElement = elements.create("payment", {
                    layout: "tabs",
                    defaultValues: {
                        billingDetails: {
                            name: '{{ request.user.get_full_name }}',
                            email: '{{ request.user.email }}',
                        }
                    }
                });

                await paymentElement.mount("#payment-element");
                document.querySelector("#submit").disabled = false;
            } catch (error) {
                console.error('Error:', error);
                showMessage(error.message || "Failed to initialize payment form. Please try again.");
            }
        }

        // Handle form submission
        async function handleSubmit(e) {
            e.preventDefault();
            setLoading(true);

            try {
                const { error } = await stripe.confirmPayment({
                    elements,
                    confirmParams: {
                        return_url: window.location.origin + "{% url 'payments:payment_success' %}",
                        payment_method_data: {
                            billing_details: {
                                name: '{{ request.user.get_full_name }}',
                                email: '{{ request.user.email }}',
                            }
                        }
                    }
                });

                if (error) {
                    if (error.type === "card_error" || error.type === "validation_error") {
                        showMessage(error.message);
                    } else {
                        showMessage("An unexpected error occurred.");
                    }
                    setLoading(false);
                }
                // If no error, the customer will be redirected to the return_url
            } catch (error) {
                console.error('Error:', error);
                showMessage("Payment failed. Please try again.");
                setLoading(false);
            }
        }

        // Update payment intent when credit amount changes
        document.getElementById('credit_amount').addEventListener('change', async () => {
            const amount = parseFloat(document.getElementById('credit_amount').value);
            const validation = validateAmount(amount);
            
            if (validation.valid) {
                setLoading(true);
                await initialize();
                setLoading(false);
            }
        });

        // UI helpers
        function showMessage(messageText) {
            const messageContainer = document.querySelector("#payment-message");
            messageContainer.classList.remove("hidden");
            messageContainer.textContent = messageText;
            setTimeout(function () {
                messageContainer.classList.add("hidden");
                messageContainer.textContent = "";
            }, 4000);
        }

        function setLoading(isLoading) {
            const submitButton = document.querySelector("#submit");
            const spinner = document.querySelector("#spinner");
            const buttonText = document.querySelector("#button-text");
            
            if (isLoading) {
                submitButton.disabled = true;
                spinner.classList.remove("hidden");
                buttonText.classList.add("hidden");
            } else {
                submitButton.disabled = false;
                spinner.classList.add("hidden");
                buttonText.classList.remove("hidden");
            }
        }

        // Add input validation
        const creditInput = document.getElementById('credit_amount');
        const errorDiv = document.getElementById('amount-error');
        const creditsPreview = document.getElementById('credits-amount');

        function validateAmount(amount) {
            const numAmount = parseFloat(amount);
            if (isNaN(numAmount)) {
                return { valid: false, message: 'Please enter a valid amount' };
            }
            if (numAmount < 5) {
                return { valid: false, message: 'Minimum amount is $5.00' };
            }
            if (numAmount > 100) {
                return { valid: false, message: 'Maximum amount is $100.00' };
            }
            return { valid: true };
        }

        function updateCreditsPreview(amount) {
            const numAmount = parseFloat(amount);
            if (!isNaN(numAmount)) {
                creditsPreview.textContent = Math.floor(numAmount);
            }
        }

        creditInput.addEventListener('input', function(e) {
            const amount = e.target.value;
            const validation = validateAmount(amount);
            
            if (!validation.valid) {
                errorDiv.textContent = validation.message;
                errorDiv.classList.remove('hidden');
                creditInput.classList.add('error');
                document.querySelector("#submit").disabled = true;
            } else {
                errorDiv.classList.add('hidden');
                creditInput.classList.remove('error');
                document.querySelector("#submit").disabled = false;
                updateCreditsPreview(amount);
            }
        });
    });
</script>
{% endblock %} 